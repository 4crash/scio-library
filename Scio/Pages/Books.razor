@page "/books"
@using Scio.Models
@using Scio.Services
@using Scio.Components
@inject BookManagementService BookManagement
@inject ToastService Toast

<h3 class="text-2xl font-bold text-scio-gray-dark mb-6">Library Book Management System</h3>

<div class="flex flex-col md:flex-row gap-4 mb-6">
    <div class="flex-1">
        <input type="text" @bind="searchTerm" @bind:event="oninput" placeholder="Search by title, author, or ISBN..." class="border border-gray-300 rounded px-3 py-2 w-full" />
    </div>
    <div class="flex gap-2">
        <button class="btn btn-primary" @onclick="LoadBooks">Refresh</button>
        <button class="btn btn-success" @onclick="ShowAddBookForm">Add New Book</button>
    </div>
</div>

<BookForm IsVisible="showAddForm" Book="newBook" OnSave="AddBook" OnCancel="CancelAdd" />

@if (books == null)
{
    <p class="text-scio-gray-dark"><em>Loading books...</em></p>
}
else if (!books.Any())
{
    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 text-blue-800">
        No books found.
    </div>
}
else
{
    <div class="space-y-4">
        @foreach (var book in books)
        {
            <BookCard 
                Book="book"
                IsHistoryExpanded="expandedBookId == book.Id"
                IsHistoryLoading="bookHistoryLoading.Contains(book.Id)"
                BorrowedRecords="GetBookHistory(book.Id)"
                OnBorrow="@(async () => await OpenBorrowModal(book.Id, book.Title, book.Author))"
                OnReturn="@(async () => await ShowReturnModalForBook(book.Id))"
                OnToggleHistory="@(async () => await ToggleBorrowHistory(book.Id))" />
        }
    </div>
}

<BorrowModal @ref="borrowModal" BookId="selectedBookId" BookTitle="selectedBookTitle" BookAuthor="selectedBookAuthor" IsOpen="showBorrowModal" OnBorrow="HandleBorrow" OnClose="CloseBorrowModal" />

<ReturnModal @ref="returnModal" BorrowedBooks="borrowedBooksList" FilterBookId="filterBookId" IsOpen="showReturnModal" OnReturn="HandleReturn" OnClose="CloseReturnModal" />

@code {
    private List<Book>? books;
    private string searchTerm = "";
    private bool showAddForm = false;
    private Book newBook = new();
    private BorrowModal? borrowModal;
    private bool showBorrowModal = false;
    private Guid selectedBookId;
    private string selectedBookTitle = string.Empty;
    private string selectedBookAuthor = string.Empty;
    private ReturnModal? returnModal;
    private bool showReturnModal = false;
    private List<BorrowedBookInfo>? borrowedBooksList;
    private Guid filterBookId = Guid.Empty;
    private Guid expandedBookId = Guid.Empty;
    private Dictionary<Guid, List<BorrowedBookInfo>> bookBorrowedHistory = new();
    private HashSet<Guid> bookHistoryLoading = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadBooks();
    }

    // Helper method to get book history safely
    private List<BorrowedBookInfo> GetBookHistory(Guid bookId)
    {
        return bookBorrowedHistory.ContainsKey(bookId) 
            ? bookBorrowedHistory[bookId] 
            : new List<BorrowedBookInfo>();
    }

    private async Task LoadBooks()
    {
        var result = await BookManagement.LoadBooksAsync(searchTerm);
        if (result.Success)
        {
            books = result.Data;
            if (searchTerm == "")
            {
                Toast.ShowSuccess($"Books loaded successfully. ({books?.Count ?? 0} books)");
            }
        }
        else
        {
            Toast.ShowFromResult(result);
            books = new List<Book>();
        }
        StateHasChanged();
    }

    private void ShowAddBookForm()
    {
        newBook = new Book();
        showAddForm = true;
    }

    private void CancelAdd()
    {
        showAddForm = false;
        newBook = new Book();
    }

    private async Task AddBook()
    {
        var result = await BookManagement.AddBookAsync(newBook);
        if (result.Success)
        {
            Toast.ShowSuccess($"Book '{newBook.Title}' added successfully!");
            showAddForm = false;
            newBook = new Book();
            await LoadBooks();
        }
        else
        {
            Toast.ShowFromResult(result);
        }
    }

    private Task OpenBorrowModal(Guid bookId, string title, string author)
    {
        selectedBookId = bookId;
        selectedBookTitle = title;
        selectedBookAuthor = author;
        showBorrowModal = true;
        StateHasChanged();
        return Task.CompletedTask;
    }

    private async Task HandleBorrow(string userName)
    {
        var result = await BookManagement.BorrowBookAsync(selectedBookId, userName);
        if (result.Success)
        {
            Toast.ShowSuccess($"Book borrowed successfully by {userName}!");
            await LoadBooks(); // Refresh the list
            // Refresh opened borrow history if a book history is expanded
            if (expandedBookId != Guid.Empty)
            {
                await RefreshBookHistory(expandedBookId);
            }
        }
        else
        {
            Toast.ShowFromResult(result);
        }
    }

    private void CloseBorrowModal()
    {
        showBorrowModal = false;
        selectedBookId = Guid.Empty;
        selectedBookTitle = string.Empty;
        selectedBookAuthor = string.Empty;
        StateHasChanged();
    }

    private async Task ShowReturnModalForBook(Guid bookId)
    {
        if (returnModal is not null)
        {
            var result = await BookManagement.GetCurrentlyBorrowedBooksAsync();
            if (result.Success && result.Data != null)
            {
                borrowedBooksList = result.Data;
                filterBookId = bookId;
                await returnModal.Open(borrowedBooksList.Cast<BorrowedBookInfo?>().ToList(), bookId);
                showReturnModal = true;
                StateHasChanged();
            }
            else
            {
                Toast.ShowFromResult(result);
            }
        }
    }

    private async Task HandleReturn(Guid borrowRecordId)
    {
        var result = await BookManagement.ReturnBookAsync(borrowRecordId);
        if (result.Success)
        {
            Toast.ShowSuccess("Book returned successfully!");
            await LoadBooks(); // Refresh the main books list
            // Refresh the borrowed books list to remove the returned item
            borrowedBooksList = null;
            // Refresh opened borrow history if a book history is expanded
            if (expandedBookId != Guid.Empty)
            {
                await RefreshBookHistory(expandedBookId);
            }
            // Close the modal
            CloseReturnModal();
        }
        else
        {
            Toast.ShowFromResult(result);
        }
    }

    private void CloseReturnModal()
    {
        showReturnModal = false;
        borrowedBooksList = null;
        StateHasChanged();
    }

    private async Task ToggleBorrowHistory(Guid bookId)
    {
        if (expandedBookId == bookId)
        {
            expandedBookId = Guid.Empty;
        }
        else
        {
            expandedBookId = bookId;
            if (!bookBorrowedHistory.ContainsKey(bookId))
            {
                await RefreshBookHistory(bookId);
            }
        }
        StateHasChanged();
    }

    private async Task RefreshBookHistory(Guid bookId)
    {
        bookHistoryLoading.Add(bookId);
        StateHasChanged();
        
        var result = await BookManagement.GetBookHistoryAsync(bookId);
        if (result.Success && result.Data != null)
        {
            bookBorrowedHistory[bookId] = result.Data;
        }
        else
        {
            // Log or handle error silently for background refresh
            bookBorrowedHistory[bookId] = new();
        }
        
        bookHistoryLoading.Remove(bookId);
        StateHasChanged();
    }
}