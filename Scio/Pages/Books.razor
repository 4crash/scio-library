@page "/books"
@using Scio.Models
@using Scio.Services
@inject IBookApiService BookApiService

<h3 class="text-2xl font-bold text-scio-gray-dark mb-6">Library Book Management System</h3>

<div class="flex flex-col md:flex-row gap-4 mb-6">
    <div class="flex-1">
        <input type="text" @bind="searchTerm" @bind:event="oninput" placeholder="Search by title, author, or ISBN..." class="border border-gray-300 rounded px-3 py-2 w-full" />
    </div>
    <div class="flex gap-2">
        <button class="btn btn-primary" @onclick="LoadBooks">Refresh</button>
        <button class="btn btn-success" @onclick="ShowAddBookForm">Add New Book</button>
    </div>
</div>

@if (showAddForm)
{
    <div class="bg-white rounded-lg shadow-md mb-6">
        <div class="px-6 py-4 border-b border-gray-200">
            <h5 class="text-xl font-bold">Add New Book</h5>
        </div>
        <div class="p-6">
            <div class="flex flex-col md:flex-row gap-6">
                <div class="flex-1">
                    <div class="mb-4">
                        <label class="form-label block text-sm font-semibold mb-2">Title *</label>
                        <input type="text" @bind="newBook.Title" class="border border-gray-300 rounded px-3 py-2 w-full" />
                    </div>
                    <div class="mb-4">
                        <label class="form-label block text-sm font-semibold mb-2">Author *</label>
                        <input type="text" @bind="newBook.Author" class="border border-gray-300 rounded px-3 py-2 w-full" />
                    </div>
                    <div class="mb-4">
                        <label class="form-label block text-sm font-semibold mb-2">Year of Publication</label>
                        <input type="number" @bind="newBook.YearOfPublication" class="border border-gray-300 rounded px-3 py-2 w-full" />
                    </div>
                </div>
                <div class="flex-1">
                    <div class="mb-4">
                        <label class="form-label block text-sm font-semibold mb-2">ISBN *</label>
                        <input type="text" @bind="newBook.ISBN" class="border border-gray-300 rounded px-3 py-2 w-full" />
                    </div>
                    <div class="mb-4">
                        <label class="form-label block text-sm font-semibold mb-2">Available Copies</label>
                        <input type="number" @bind="newBook.AvailableCopies" class="border border-gray-300 rounded px-3 py-2 w-full" min="0" />
                    </div>
                </div>
            </div>
            <div class="flex gap-2 mt-6">
                <button class="btn btn-success" @onclick="AddBook">Save Book</button>
                <button class="btn btn-secondary" @onclick="CancelAdd">Cancel</button>
            </div>
        </div>
    </div>
}

@if (books == null)
{
    <p class="text-scio-gray-dark"><em>Loading books...</em></p>
}
else if (!books.Any())
{
    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 text-blue-800">
        No books found. @if (!string.IsNullOrWhiteSpace(searchTerm)) { <text>Try adjusting your search term.</text> }
    </div>
}
else
{
    <div class="overflow-x-auto">
        <table class="w-full border-collapse">
            <thead>
                <tr class="bg-gray-100 border-b border-gray-300">
                    <th class="text-left px-4 py-3 font-semibold text-scio-gray-dark">Title</th>
                    <th class="text-left px-4 py-3 font-semibold text-scio-gray-dark">Author</th>
                    <th class="text-left px-4 py-3 font-semibold text-scio-gray-dark">Year</th>
                    <th class="text-left px-4 py-3 font-semibold text-scio-gray-dark">ISBN</th>
                    <th class="text-left px-4 py-3 font-semibold text-scio-gray-dark">Available</th>
                    <th class="text-left px-4 py-3 font-semibold text-scio-gray-dark">Actions</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var book in books)
                {
                    <tr class="border-b border-gray-200 hover:bg-gray-50">
                        <td class="px-4 py-3"><strong>@book.Title</strong></td>
                        <td class="px-4 py-3">@book.Author</td>
                        <td class="px-4 py-3">@book.YearOfPublication</td>
                        <td class="px-4 py-3"><code class="bg-gray-100 px-2 py-1 rounded text-sm">@book.ISBN</code></td>
                        <td class="px-4 py-3">
                            <span class="px-3 py-1 rounded-full text-white text-sm @(book.AvailableCopies > 0 ? "bg-green-600" : "bg-red-600")">
                                @book.AvailableCopies
                            </span>
                        </td>
                        <td class="px-4 py-3">
                            <div class="flex gap-2">
                               
                                    <button class=" text-white text-sm px-2 py-1 rounded @(book.AvailableCopies>0 ? "bg-yellow-600 hover:bg-yellow-700" : "bg-gray-500 hover:bg-gray-500 cursor-not-allowed")"   @onclick="@(() => BorrowBook(book.Id))" disabled="@(book.AvailableCopies == 0)">
                                        Borrow
                                    </button>
                               
                                <button class="bg-blue-600 hover:bg-blue-700 text-white text-sm px-2 py-1 rounded" @onclick="@(() => ReturnBook(book.Id))">
                                    Return
                                </button>
                            </div>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
}

@code {
    private List<Book>? books;
    private string searchTerm = "";
    private bool showAddForm = false;
    private Book newBook = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadBooks();
    }

    private async Task LoadBooks()
    {
        if (string.IsNullOrWhiteSpace(searchTerm))
        {
            books = await BookApiService.GetAllBooksAsync();
        }
        else
        {
            books = await BookApiService.SearchBooksAsync(searchTerm);
        }
        StateHasChanged();
    }

    private void ShowAddBookForm()
    {
        newBook = new Book();
        showAddForm = true;
    }

    private void CancelAdd()
    {
        showAddForm = false;
        newBook = new Book();
    }

    private async Task AddBook()
    {
        if (string.IsNullOrWhiteSpace(newBook.Title) ||
            string.IsNullOrWhiteSpace(newBook.Author) ||
            string.IsNullOrWhiteSpace(newBook.ISBN))
        {
            return; // Validation would be handled here
        }

        await BookApiService.AddBookAsync(newBook);
        showAddForm = false;
        newBook = new Book();
        await LoadBooks();
    }

    private async Task BorrowBook(Guid bookId)
    {
        var success = await BookApiService.BorrowBookAsync(bookId);
        if (success)
        {
            await LoadBooks(); // Refresh the list
        }
    }

    private async Task ReturnBook(Guid bookId)
    {
        var success = await BookApiService.ReturnBookAsync(bookId);
        if (success)
        {
            await LoadBooks(); // Refresh the list
        }
    }
}